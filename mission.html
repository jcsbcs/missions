<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Report - Classified</title>
    <style>
        html {
            background: #000;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            overflow-x: hidden;
            padding: 20px;
        }

        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 1000;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .classified-header {
            text-align: center;
            border: 3px solid #c41e3a;
            background: rgba(196, 30, 58, 0.1);
            padding: 15px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(196, 30, 58, 0.3);
        }

        .classified-text {
            color: #c41e3a;
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 8px;
            text-shadow: 0 0 10px rgba(196, 30, 58, 0.5);
        }

        .security-level {
            color: #ff6b6b;
            font-size: 14px;
            margin-top: 10px;
            letter-spacing: 3px;
        }

        .welcome-section {
            background: rgba(0, 255, 0, 0.05);
            border: 2px solid #0f0;
            padding: 40px;
            margin: 40px 0;
            text-align: center;
            box-shadow: 
                0 0 30px rgba(0, 255, 0, 0.2),
                inset 0 0 30px rgba(0, 255, 0, 0.05);
            animation: fadeIn 1s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-text {
            font-size: 42px;
            color: #0f0;
            text-shadow: 
                0 0 10px #0f0,
                0 0 20px #0f0,
                0 0 30px #0f0;
            letter-spacing: 3px;
            margin-bottom: 10px;
            font-family: monospace;
            position: relative;
        }

        .welcome-text::before {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            animation: glitchEffect 2s infinite;
            clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
            transform: translate(-2px, -2px);
            color: #0f0;
            text-shadow: 0 0 5px #0f0, 0 0 15px #0f0;
        }

        @keyframes glitchEffect {
            0%, 100% {
                clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
                transform: translate(0);
            }
            33% {
                clip-path: polygon(0 0, 100% 0, 100% 15%, 0 15%);
                transform: translate(-5px, -5px);
            }
            66% {
                clip-path: polygon(0 85%, 100% 85%, 100% 100%, 0 100%);
                transform: translate(5px, 5px);
            }
        }

        .agent-name {
            color: #00ff00;
            font-weight: bold;
            text-transform: uppercase;
            font-family: monospace;
            position: relative;
            text-shadow: 0 0 10px #0f0, 0 0 20px #0f0, 0 0 30px #0f0;
        }

        .agent-name::before {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            animation: glitchEffect 2s infinite;
            clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
            transform: translate(-2px, -2px);
            color: #0f0;
            text-shadow: 0 0 5px #0f0, 0 0 15px #0f0;
        }

        .report-body {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid #333;
            padding: 30px;
            margin: 20px 0;
        }

        .section {
            margin: 30px 0;
            padding: 20px;
            border-left: 3px solid #0f0;
            background: rgba(0, 255, 0, 0.02);
        }

        .section-title {
            color: #0f0;
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 2px;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .decrypt-text {
            line-height: 2;
            margin-top: 20px;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 16px;
        }

        .decrypt-char {
            display: inline-block;
            color: #0f0;
            margin: 0 2px;
        }

        .mission-text {
            font-size: 18px;
            font-weight: bold;
            margin-top: 30px;
            line-height: 2.2;
            letter-spacing: 1px;
        }

        .mission-text .decrypt-char {
            margin: 0 3px;
        }

        .info-line {
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #222;
        }

        .label {
            color: #888;
            display: inline-block;
            width: 200px;
        }

        .value {
            color: #0f0;
        }

        .stamp {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #c41e3a;
            font-size: 48px;
            font-weight: bold;
            opacity: 0.3;
            transform: rotate(-15deg);
            border: 5px solid #c41e3a;
            padding: 10px 30px;
            letter-spacing: 5px;
        }

        .redacted {
            background: #000;
            color: #000;
            padding: 2px 40px;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .welcome-text {
                font-size: 28px;
            }
            .classified-text {
                font-size: 24px;
            }
            .stamp {
                font-size: 32px;
                padding: 5px 15px;
            }
            .decrypt-text {
                font-size: 14px;
                line-height: 1.9;
            }
            .mission-text {
                font-size: 16px;
                line-height: 2;
            }
            .decrypt-char {
                margin: 0 1px;
            }
            .mission-text .decrypt-char {
                margin: 0 2px;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <div class="scanlines"></div>
    
    <div class="container">
        <div class="stamp">TOP SECRET</div>
        
        <div class="classified-header">
            <div class="classified-text">CLASSIFIED</div>
            <div class="security-level">SECURITY CLEARANCE: LEVEL 5 REQUIRED</div>
        </div>

        <div class="welcome-section">
            <div class="welcome-text" data-text="WELCOME BACK">WELCOME BACK</div>
            <div class="welcome-text" data-text="">AGENT <span class="agent-name" id="agentName" data-text="">UNKNOWN</span></div>
        </div>

        <div class="report-body">
            <div class="section">
                <div class="section-title">Mission Briefing</div>
                <p class="decrypt-text" id="briefing1"></p>
                <p class="decrypt-text mission-text" id="briefing2"></p>
            </div>
        </div>

        <div style="text-align: center; margin-top: 40px; color: #555; font-size: 12px;">
            <p>THIS DOCUMENT IS PROPERTY OF [REDACTED]</p>
            <p>UNAUTHORIZED ACCESS IS PUNISHABLE BY LAW</p>
            <p>DOCUMENT ID: MR-<span id="docId"></span></p>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAGDDZS4X7V8m6h_L4__GxtITHiwyyQ2LQ",
            authDomain: "missions-7a024.firebaseapp.com",
            projectId: "missions-7a024",
            storageBucket: "missions-7a024.firebasestorage.app",
            messagingSenderId: "907803260147",
            appId: "1:907803260147:web:023fd43873947ce21c3386",
            measurementId: "G-P6VHBK3D3L"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Mission pool with availability counts
        const missionPool = [
            { text: "Kiss someone in the Photo Booth", count: 1 },
            { text: "Make a TikTok with a random", count: 1 },
            { text: "Get a random's number", count: 1 },
            { text: "Steal something while we are out", count: 3 },
            { text: "Jump in the ocean at night (naked?)", count: 1 },
            { text: "Get everyone to do a conga line", count: 3 },
            { text: "Do NOT let a conga line happen", count: 2 },
            { text: "Pour everyone fake shots and cheers", count: 1 },
            { text: "Give a cheers speech", count: 1 },
            { text: "Go on a side mission and vlog it", count: 1 },
            { text: "Kidnap a random back to the house", count: 1 },
            { text: "Trade costumes with someone", count: 1 },
            { text: "Get a piggy back ride", count: 1 },
            { text: "Find the person who's hiding", count: 1 },
            { text: "Get as many people as you can in the hot tub", count: 1 },
            { text: "You must volunteer to do the bitch cup after the first game of rage cage", count: 1 },
            { text: "Get someone to feed you your shots for the night", count: 1 },
            { text: "Vlog the whole night", count: 1 },
            { text: "Start a limbo line", count: 1 },
            { text: "Take a body shot off of someone", count: 1 },
            { text: "Give a body shot", count: 1 },
            { text: "Interview a stranger", count: 1 }
        ];

        // Get agent name from URL
        const params = new URLSearchParams(window.location.search);
        const agentName = params.get('agent') || 'UNKNOWN';
        const agentNameElement = document.getElementById('agentName');
        agentNameElement.textContent = agentName;
        agentNameElement.setAttribute('data-text', agentName);

        // Set data-text for welcome text elements
        const welcomeTexts = document.querySelectorAll('.welcome-text');
        welcomeTexts.forEach(el => {
            if (!el.getAttribute('data-text')) {
                el.setAttribute('data-text', el.textContent.trim());
            }
        });

        // Firebase-based mission assignment
        async function assignMission() {
            try {
                const agentRef = db.collection('agents').doc(agentName);
                const assignmentsRef = db.collection('system').doc('assignments');

                // Check if agent already has a mission
                const agentDoc = await agentRef.get();
                if (agentDoc.exists) {
                    return agentDoc.data().mission;
                }

                // Use Firestore transaction to prevent race conditions
                return await db.runTransaction(async (transaction) => {
                    const assignmentsDoc = await transaction.get(assignmentsRef);
                    
                    let assignments = {};
                    if (assignmentsDoc.exists) {
                        assignments = assignmentsDoc.data();
                    }

                    // Build available missions list
                    const availableMissions = [];
                    missionPool.forEach((mission, index) => {
                        const assigned = assignments[index] || 0;
                        const remaining = mission.count - assigned;
                        for (let i = 0; i < remaining; i++) {
                            availableMissions.push({ text: mission.text, index: index });
                        }
                    });

                    if (availableMissions.length === 0) {
                        return "All missions have been assigned. Contact mission control for further instructions.";
                    }

                    // Randomly select a mission
                    const selected = availableMissions[Math.floor(Math.random() * availableMissions.length)];
                    
                    // Update assignments
                    assignments[selected.index] = (assignments[selected.index] || 0) + 1;
                    
                    // Save to Firestore
                    transaction.set(assignmentsRef, assignments);
                    transaction.set(agentRef, {
                        mission: selected.text,
                        assignedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    return selected.text;
                });
            } catch (error) {
                console.error('Firebase error:', error);
                return "Error connecting to mission control. Please try again.";
            }
        }

        // Mission briefing with assigned mission
        assignMission().then(mission => {
            const briefing1 = `AGENT ${agentName.toUpperCase()}, your mission has been assigned. This is a covert operation requiring discretion and commitment.`;
            const briefing2 = `YOUR MISSION: ${mission}`;
            
            // Cryptographic decryption effect
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@#$%^&*!?<>[]{}+=';
            
            function decryptText(element, finalText) {
                let html = '';
                for (let i = 0; i < finalText.length; i++) {
                    if (finalText[i] === ' ') {
                        html += ' ';
                    } else {
                        html += `<span class="decrypt-char" data-index="${i}">${chars[Math.floor(Math.random() * chars.length)]}</span>`;
                    }
                }
                element.innerHTML = html;

                const spans = element.querySelectorAll('.decrypt-char');
                
                spans.forEach((span, index) => {
                    const finalChar = finalText[index];
                    const decryptDuration = 1500 + Math.random() * 2000;
                    const iterations = 30 + Math.floor(Math.random() * 40);
                    let currentIteration = 0;
                    
                    const interval = setInterval(() => {
                        if (currentIteration < iterations) {
                            span.textContent = chars[Math.floor(Math.random() * chars.length)];
                            span.style.textShadow = '0 0 8px #0f0';
                            currentIteration++;
                        } else {
                            clearInterval(interval);
                            span.textContent = finalChar;
                            span.style.textShadow = '0 0 5px #0f0';
                        }
                    }, decryptDuration / iterations);
                });
            }

            setTimeout(() => {
                decryptText(document.getElementById('briefing1'), briefing1);
                decryptText(document.getElementById('briefing2'), briefing2);
            }, 500);
        });

        // Generate random document ID
        const docId = Math.random().toString(36).substr(2, 9).toUpperCase();
        document.getElementById('docId').textContent = docId;
    </script>
</body>
</html>
