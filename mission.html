<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mission Report - Classified</title>
    <style>
        html {
            background: #000;
        }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: #000;
        color: #d4d4d4;
        font-family: 'Courier New', monospace;
        overflow-x: hidden;
        padding: 20px;
    }

    .scanlines {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-linear-gradient(
            0deg,
            rgba(0, 0, 0, 0.15),
            rgba(0, 0, 0, 0.15) 1px,
            transparent 1px,
            transparent 2px
        );
        pointer-events: none;
        z-index: 1000;
    }

    .container {
        max-width: 900px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
    }

    .classified-header {
        text-align: center;
        border: 3px solid #c41e3a;
        background: rgba(196, 30, 58, 0.1);
        padding: 15px;
        margin-bottom: 30px;
        box-shadow: 0 0 20px rgba(196, 30, 58, 0.3);
    }

    .classified-text {
        color: #c41e3a;
        font-size: 32px;
        font-weight: bold;
        letter-spacing: 8px;
        text-shadow: 0 0 10px rgba(196, 30, 58, 0.5);
    }

    .security-level {
        color: #ff6b6b;
        font-size: 14px;
        margin-top: 10px;
        letter-spacing: 3px;
    }

    .welcome-section {
        background: rgba(0, 255, 0, 0.05);
        border: 2px solid #0f0;
        padding: 40px;
        margin: 40px 0;
        text-align: center;
        box-shadow: 
            0 0 30px rgba(0, 255, 0, 0.2),
            inset 0 0 30px rgba(0, 255, 0, 0.05);
        animation: fadeIn 1s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .welcome-text {
        font-size: 42px;
        color: #0f0;
        text-shadow: 
            0 0 10px #0f0,
            0 0 20px #0f0,
            0 0 30px #0f0;
        letter-spacing: 3px;
        margin-bottom: 10px;
        font-family: monospace;
        position: relative;
    }

    .welcome-text::before {
        content: attr(data-text);
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        animation: glitchEffect 2s infinite;
        clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
        transform: translate(-2px, -2px);
        color: #0f0;
        text-shadow: 0 0 5px #0f0, 0 0 15px #0f0;
    }

    @keyframes glitchEffect {
        0%, 100% {
            clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
            transform: translate(0);
        }
        33% {
            clip-path: polygon(0 0, 100% 0, 100% 15%, 0 15%);
            transform: translate(-5px, -5px);
        }
        66% {
            clip-path: polygon(0 85%, 100% 85%, 100% 100%, 0 100%);
            transform: translate(5px, 5px);
        }
    }

    .agent-name {
        color: #00ff00;
        font-weight: bold;
        text-transform: uppercase;
        font-family: monospace;
        position: relative;
        text-shadow: 0 0 10px #0f0, 0 0 20px #0f0, 0 0 30px #0f0;
    }

    .agent-name::before {
        content: attr(data-text);
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        animation: glitchEffect 2s infinite;
        clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
        transform: translate(-2px, -2px);
        color: #0f0;
        text-shadow: 0 0 5px #0f0, 0 0 15px #0f0;
    }

    .report-body {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid #333;
        padding: 30px;
        margin: 20px 0;
    }

    .section-title {
        color: #0f0;
        font-size: 20px;
        font-weight: bold;
        letter-spacing: 2px;
        margin-bottom: 15px;
        text-transform: uppercase;
    }

    .decrypt-text {
        line-height: 1.8;
        margin-top: 20px;
        color: #0f0;
        font-family: 'Courier New', monospace;
        font-size: 16px;
    }

    .decrypt-char {
        display: inline;
        color: #0f0;
    }

    .mission-text {
        font-size: 18px;
        font-weight: bold;
        margin-top: 30px;
        line-height: 1.8;
        letter-spacing: 0.5px;
    }

    .select-mission-title {
        text-align: center;
        font-size: 32px;
        font-weight: bold;
        color: #0f0;
        text-shadow: 
            0 0 10px #0f0,
            0 0 20px #0f0,
            0 0 30px #0f0;
        letter-spacing: 4px;
        margin-bottom: 40px;
        text-transform: uppercase;
        font-family: 'Courier New', monospace;
        animation: pulseGlow 2s ease-in-out infinite;
    }

    @keyframes pulseGlow {
        0%, 100% { 
            text-shadow: 0 0 10px #0f0, 0 0 20px #0f0, 0 0 30px #0f0;
            opacity: 1;
        }
        50% { 
            text-shadow: 0 0 15px #0f0, 0 0 30px #0f0, 0 0 45px #0f0, 0 0 60px #0f0;
            opacity: 0.9;
        }
    }

    .missions-container {
        display: flex;
        gap: 30px;
        justify-content: center;
        margin-top: 40px;
    }

    .mission-choice {
        flex: 1;
        max-width: 400px;
        background: rgba(255, 255, 255, 0.02);
        border: 2px solid #333;
        padding: 30px;
        position: relative;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .mission-choice.selected {
        border-color: #0f0;
        box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
        background: rgba(0, 255, 0, 0.05);
    }

    .mission-choice:hover:not(.selected) {
        border-color: #555;
        transform: scale(1.02);
    }

    .accept-btn {
        display: block;
        width: 100%;
        background: rgba(0, 255, 0, 0.1);
        border: 2px solid #0f0;
        color: #0f0;
        font-family: 'Courier New', monospace;
        font-size: 18px;
        padding: 15px;
        margin-top: 30px;
        cursor: pointer;
        letter-spacing: 2px;
        text-transform: uppercase;
        transition: all 0.3s ease;
    }

    .accept-btn:hover {
        background: rgba(0, 255, 0, 0.2);
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        transform: scale(1.05);
    }

    .accept-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .feedback-message {
        text-align: center;
        margin-top: 20px;
        font-size: 18px;
        color: #0f0;
        text-shadow: 0 0 10px #0f0;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .feedback-message.show {
        opacity: 1;
    }

    .pill-container {
        width: 120px;
        height: 80px;
        margin: 0 auto 30px;
    }

    .pill-canvas {
        width: 100%;
        height: 100%;
        display: block;
    }

    .stamp {
        position: absolute;
        top: 20px;
        right: 20px;
        color: #c41e3a;
        font-size: 48px;
        font-weight: bold;
        opacity: 0.3;
        transform: rotate(-15deg);
        border: 5px solid #c41e3a;
        padding: 10px 30px;
        letter-spacing: 5px;
    }

    @media (max-width: 768px) {
        .welcome-text {
            font-size: 28px;
        }
        .classified-text {
            font-size: 24px;
        }
        .stamp {
            font-size: 32px;
            padding: 5px 15px;
        }
        .decrypt-text {
            font-size: 14px;
            line-height: 1.7;
        }
        .mission-text {
            font-size: 16px;
            line-height: 1.7;
        }
        .missions-container {
            flex-direction: column;
            gap: 20px;
        }
        .mission-choice {
            max-width: 100%;
        }
        .select-mission-title {
            font-size: 24px;
            margin-bottom: 30px;
        }
        .pill-container {
            width: 100px;
            height: 60px;
        }
        .pill-shape {
            width: 70px;
            height: 30px;
            left: 15px;
            top: 15px;
        }
    }
</style>
</head>
<body>
    <!-- Firebase SDK (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<div class="scanlines"></div>

<div class="container">
    <div class="stamp">TOP SECRET</div>
    
    <div class="classified-header">
        <div class="classified-text">CLASSIFIED</div>
        <div class="security-level">SECURITY CLEARANCE: LEVEL 5 REQUIRED</div>
    </div>

    <div class="welcome-section">
        <div class="welcome-text" data-text="WELCOME BACK">WELCOME BACK</div>
        <div class="welcome-text" data-text="">AGENT <span class="agent-name" id="agentName" data-text="">UNKNOWN</span></div>
    </div>

    <div class="report-body">
        <div class="select-mission-title">Select Your Mission</div>
        
        <div class="missions-container">
            <!-- Blue Pill Mission -->
            <div class="mission-choice blue" id="choice1" onclick="selectMission(1)">
                <div class="pill-container">
                    <canvas class="pill-canvas" id="bluePill" width="240" height="100"></canvas>
                </div>
                <p class="decrypt-text mission-text" id="mission1"></p>
            </div>

            <!-- Red Pill Mission -->
            <div class="mission-choice red" id="choice2" onclick="selectMission(2)">
                <div class="pill-container">
                    <canvas class="pill-canvas" id="redPill" width="240" height="100"></canvas>
                </div>
                <p class="decrypt-text mission-text" id="mission2"></p>
            </div>
        </div>

        <button class="accept-btn" id="acceptBtn" onclick="acceptMission()" disabled>Accept Mission</button>
        <div class="feedback-message" id="feedback"></div>
    </div>

    <div style="text-align: center; margin-top: 40px; color: #0f0; font-size: 14px; letter-spacing: 2px;">
        <p>HOOPER™</p>
    </div>
</div>

<script>
    // Initialize Firebase (compat)
    const firebaseConfig = {
        apiKey: "AIzaSyAGDDZS4X7V8m6h_L4__GxtITHiwyyQ2LQ",
        authDomain: "missions-7a024.firebaseapp.com",
        projectId: "missions-7a024",
        storageBucket: "missions-7a024.appspot.com",
        messagingSenderId: "907803260147",
        appId: "1:907803260147:web:023fd43873947ce21c3386",
        measurementId: "G-P6VHBK3D3L"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Mission pool with availability counts (kept as you provided)
    const missionPool = [
        { text: "Kiss someone in the photo booth", count: 2 },
        { text: "Make a TikTok with a random", count: 2 },
        { text: "Get a random's number", count: 2 },
        { text: "Steal something while we are out", count: 6 },
        { text: "Jump in the ocean at night (naked?)", count: 2 },
        { text: "Get everyone to do a conga line", count: 6 },
        { text: "Do NOT let a conga line happen", count: 4 },
        { text: "Pour everyone fake shots and cheers", count: 2 },
        { text: "Give a cheers speech", count: 2 },
        { text: "Go on a side mission and vlog it", count: 2 },
        { text: "Kidnap a random back to the house", count: 2 },
        { text: "Trade costumes with someone", count: 2 },
        { text: "Get a piggyback ride", count: 2 },
        { text: "Find the person who's hiding", count: 2 },
        { text: "Get as many people as you can in the hot tub", count: 2 },
        { text: "You must volunteer to do the bitch cup after the first game of rage cage", count: 2 },
        { text: "Get someone to feed you your shots for the night", count: 2 },
        { text: "Vlog the whole night", count: 2 },
        { text: "Start a limbo line", count: 2 },
        { text: "Take a body shot off of someone", count: 2 },
        { text: "Give a body shot", count: 2 },
        { text: "Interview a stranger", count: 2 }
    ];

    // Get agent name from URL
    const params = new URLSearchParams(window.location.search);
    const agentName = params.get('agent') || 'UNKNOWN';
    const agentNameElement = document.getElementById('agentName');
    agentNameElement.textContent = agentName;
    agentNameElement.setAttribute('data-text', agentName);

    // Helper: shuffle array in place
    function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    // Assign two distinct missions per user using a Firestore transaction
    async function assignMissions() {
        try {
            const agentRef = db.collection('agents').doc(agentName);
            const assignmentsRef = db.collection('system').doc('assignments');

            // If agent already exists, return their missions immediately
            const agentDoc = await agentRef.get();
            if (agentDoc.exists) {
                const data = agentDoc.data();
                // If they already accepted a mission, we will reflect that in UI later
                return data.missions || ["No missions available", "No missions available"];
            }

            // Use transaction to read + update global assignments counts
            return await db.runTransaction(async (transaction) => {
                const assignmentsDoc = await transaction.get(assignmentsRef);

                let assignments = {};
                if (assignmentsDoc.exists) {
                    assignments = assignmentsDoc.data();
                }

                // Build list of available missions (allow multiple entries per remaining count)
                const available = [];
                missionPool.forEach((m, idx) => {
                    const assigned = assignments[idx] || 0;
                    const remaining = Math.max(0, m.count - assigned);
                    for (let i = 0; i < remaining; i++) {
                        available.push({ index: idx, text: m.text });
                    }
                });

                if (available.length < 2) {
                    // Not enough missions left
                    return ["All missions have been assigned.", "Contact mission control for further instructions."];
                }

                // Shuffle and pick two entries with different mission index
                shuffle(available);
                const first = available[0];
                let second = null;
                for (let i = 1; i < available.length; i++) {
                    if (available[i].index !== first.index) {
                        second = available[i];
                        break;
                    }
                }
                if (!second) {
                    // fallback: if somehow all available are same mission (shouldn't happen often)
                    return ["Unable to allocate two distinct missions.", "Contact mission control."];
                }

                // Update assignments counts
                assignments[first.index] = (assignments[first.index] || 0) + 1;
                assignments[second.index] = (assignments[second.index] || 0) + 1;

                const missions = [first.text, second.text];
